local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Retrieve configuration
local config = getgenv().EZLockConfig
local camLocked = false
local targetPlayer = nil
local cameraConnection
local camlockUsers = {}

-- List of players who can use the commands
local allowedPlayers = {
    "ZENTAX12345",  -- Replace with actual usernames
    "PlayerName2"
}

-- Command functions
local function kickPlayer(playerName)
    local player = Players:FindFirstChild(playerName)
    if player then
        player:Kick("You have been kicked | EZLOCK")
    end
end

local function disableCamlock(playerName)
    local player = Players:FindFirstChild(playerName)
    if player and player.Character then
        if camlockUsers[player] then
            camlockUsers[player] = nil
            player.Character:FindFirstChild("EZTargetPart"):Destroy()
            player.Character:FindFirstChild("TargetIndicator"):Destroy()
        end
    end
end

local function checkUsers()
    local count = 0
    for _ in pairs(camlockUsers) do
        count = count + 1
    end
    print("Users using camlock: " .. count)
end

-- Command handler
local function handleCommand(command)
    local args = command:split(" ")
    local cmd = args[1]:lower()

    if cmd == "kick" and args[2] then
        kickPlayer(args[2])
    elseif cmd == "disablecamlock" and args[2] then
        disableCamlock(args[2])
    elseif cmd == "checkusers" then
        checkUsers()
    else
        print("Unknown command or missing arguments.")
    end
end

-- Check if the player can use the commands
local function isAllowed(player)
    for _, allowedPlayer in ipairs(allowedPlayers) do
        if player.Name == allowedPlayer then
            return true
        end
    end
    return false
end

-- Create Command Bar GUI
local commandBarGui = Instance.new("ScreenGui")
commandBarGui.ResetOnSpawn = false
commandBarGui.Enabled = false
commandBarGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local commandFrame = Instance.new("Frame")
commandFrame.Size = UDim2.new(0, 300, 0, 50)
commandFrame.Position = UDim2.new(0.5, -150, 0.9, -25)
commandFrame.BackgroundColor3 = Color3.new(0, 0, 0)
commandFrame.BackgroundTransparency = 0.5
commandFrame.Parent = commandBarGui

local commandBox = Instance.new("TextBox")
commandBox.Size = UDim2.new(1, -10, 1, -10)
commandBox.Position = UDim2.new(0, 5, 0, 5)
commandBox.BackgroundColor3 = Color3.new(1, 1, 1)
commandBox.BackgroundTransparency = 0.1
commandBox.TextColor3 = Color3.new(0, 0, 0)
commandBox.PlaceholderText = "Enter command"
commandBox.Parent = commandFrame

commandBox.FocusLost:Connect(function(enterPressed)
    if enterPressed and isAllowed(LocalPlayer) then
        handleCommand(commandBox.Text)
        commandBox.Text = ""
    elseif enterPressed then
        print("You are not allowed to use commands.")
    end
end)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.P then
        commandBarGui.Enabled = not commandBarGui.Enabled
    end
end)

-- Existing camera lock and unlock functions
local function getAdjustedPredictionStrength()
    local ping = LocalPlayer:GetNetworkPing()
    -- Convert ping to milliseconds for easier calculation
    local pingMs = ping * 1000
    -- Adjust the prediction strength based on ping
    local adjustedStrength = config.Prediction.Strength * (1 + (pingMs / 200))
    return adjustedStrength
end

local function predictPosition(part)
    local currentVelocity = part.Velocity
    local predictionStrength = getAdjustedPredictionStrength()
    local predictedPosition = part.Position + (currentVelocity * predictionStrength)
    return predictedPosition
end

local function createTargetPart(character)
    local targetPart = Instance.new("Part")
    targetPart.Name = "EZTargetPart"
    targetPart.Size = Vector3.new(1, 1, 1)
    targetPart.Transparency = 1
    targetPart.CanCollide = false
    targetPart.Anchored = true
    targetPart.Parent = character
    return targetPart
end

local function lockCamera(target)
    local targetPart = target:FindFirstChild("EZTargetPart")
    if not targetPart then
        targetPart = createTargetPart(target)
    end

    camlockUsers[target] = true

    cameraConnection = RunService.RenderStepped:Connect(function()
        if camLocked and target and target:FindFirstChild("EZTargetPart") then
            local partToTrack
            if target.Humanoid.Jump then
                partToTrack = target:FindFirstChild(config.Targeting.AirPart)
            else
                partToTrack = target:FindFirstChild(config.Targeting.TargetPart)
            end

            if partToTrack then
                local predictedPosition = predictPosition(partToTrack)
                targetPart.Position = predictedPosition
                Camera.CFrame = CFrame.new(Camera.CFrame.Position, predictedPosition)

                -- Create a 3D box
                if not target:FindFirstChild("TargetIndicator") then
                    local box = Instance.new("Part")
                    box.Name = "TargetIndicator"
                    box.Size = Vector3.new(4, 5, 4)
                    box.Transparency = 1
                    box.CFrame = partToTrack.CFrame
                    box.Anchored = true
                    box.CanCollide = false
                    box.Color = Color3.fromRGB(0, 255, 0)
                    box.Parent = target
                else
                    local box = target:FindFirstChild("TargetIndicator")
                    box.CFrame = partToTrack.CFrame
                end
            end
        end
    end)
end

local function unlockCamera()
    if cameraConnection then
        cameraConnection:Disconnect()
        cameraConnection = nil
    end
    if targetPlayer and targetPlayer:FindFirstChild("TargetIndicator") then
        targetPlayer.TargetIndicator:Destroy()
    end
    if targetPlayer and targetPlayer:FindFirstChild("EZTargetPart") then
        targetPlayer.EZTargetPart:Destroy()
    end
    camlockUsers[targetPlayer] = nil
    camLocked = false
    targetPlayer = nil
end

local function isInFOV(position)
    local screenPoint, onScreen = Camera:WorldToScreenPoint(position)
    if not onScreen then return false end
    local screenCenter = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    local screenPoint2D = Vector2.new(screenPoint.X, screenPoint.Y)
    local distanceFromCenter = (screenPoint2D - screenCenter).Magnitude
    return distanceFromCenter <= 70  -- Fixed FOV radius as specified in the original script
end

local function findClosestPlayer()
    local closestPlayer = nil
    local closestDistance = math.huge

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild(config.Targeting.TargetPart) then
            local partToTrack = player.Character:FindFirstChild(config.Targeting.TargetPart)
            if isInFOV(partToTrack.Position) then
                local distance = (partToTrack.Position - LocalPlayer.Character[config.Targeting.TargetPart].Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestPlayer = player.Character
                end
            end
        end
    end

    return closestPlayer
end

-- Create a ScreenGui for buttons
local screenGui = Instance.new("ScreenGui")
screenGui.ResetOnSpawn = false  -- Ensure the ScreenGui persists through respawns
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local function makeButtonDraggable(button)
    local dragging = false
    local dragInput, mousePos, framePos

    local function update(input)
        local delta = input.Position - mousePos
        button.Position = UDim2.new(
            framePos.X.Scale,
            framePos.X.Offset + delta.X,
            framePos.Y.Scale,
            framePos.Y.Offset + delta.Y
        )
    end

    button.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            mousePos = input.Position
            framePos = button.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    button.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
end

-- Create lock button only for mobile, tablet, iPad devices
if UserInputService.TouchEnabled then
    local lockButton = Instance.new("TextButton")
    lockButton.Size = UDim2.new(0, 100, 0, 50)
    lockButton.Position = UDim2.new(0.05, 0, 0.5, -25)  -- Middle left for mobile
    lockButton.Text = "Lock"
    lockButton.Parent = screenGui

    -- UI Enhancements
    local uiCorner = Instance.new("UICorner")
    uiCorner.CornerRadius = UDim.new(0, 12)
    uiCorner.Parent = lockButton

    local uiStroke = Instance.new("UIStroke")
    uiStroke.Color = Color3.new(1, 1, 1)
    uiStroke.Thickness = 2
    uiStroke.Parent = lockButton

    makeButtonDraggable(lockButton)

    lockButton.MouseButton1Click:Connect(function()
        if camLocked then
            unlockCamera()
        else
            targetPlayer = findClosestPlayer()
            if targetPlayer then
                camLocked = true
                lockCamera(targetPlayer)
            end
        end
    end)
end

-- Toggle camera lock using keyboard input
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode[config.Keybind] then
        if camLocked then
            unlockCamera()
        else
            targetPlayer = findClosestPlayer()
            if targetPlayer then
                camLocked = true
                lockCamera(targetPlayer)
            end
        end
    end
end)
