local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local camLocked = false 
local targetPlayer = nil
local fovRadius = 70
local cameraConnection

local function predictPosition(humanoidRootPart)
    local currentVelocity = humanoidRootPart.Velocity
    local predictedPosition = humanoidRootPart.Position + (currentVelocity * prediction)
    return predictedPosition
end

local function createTargetPart(character)
    local targetPart = Instance.new("Part")
    targetPart.Name = "EZTargetPart"
    targetPart.Size = Vector3.new(1, 1, 1)
    targetPart.Transparency = 1
    targetPart.CanCollide = false
    targetPart.Anchored = true
    targetPart.Parent = character
    return targetPart
end

local function lockCamera(target)
    local targetPart = target:FindFirstChild("EZTargetPart")
    if not targetPart then
        targetPart = createTargetPart(target)
    end

    cameraConnection = RunService.RenderStepped:Connect(function()
        if camLocked and target and target:FindFirstChild("EZTargetPart") then
            local partToTrack = target[TargetPart]
            local predictedPosition = predictPosition(partToTrack)
            targetPart.Position = predictedPosition
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, predictedPosition)
            
            -- Create a 3D box
            if not target:FindFirstChild("TargetIndicator") then
                local box = Instance.new("Part")
                box.Name = "TargetIndicator"
                box.Size = Vector3.new(4, 5, 4)
                box.Transparency = 1
                box.CFrame = partToTrack.CFrame
                box.Anchored = true
                box.CanCollide = false
                box.Color = Color3.fromRGB(0, 255, 0)
                box.Parent = target
            else
                local box = target:FindFirstChild("TargetIndicator")
                box.CFrame = partToTrack.CFrame
            end
        end
    end)
end

local function unlockCamera()
    if cameraConnection then
        cameraConnection:Disconnect()
        cameraConnection = nil
    end
    if targetPlayer and targetPlayer:FindFirstChild("TargetIndicator") then
        targetPlayer.TargetIndicator:Destroy()
    end
    if targetPlayer and targetPlayer:FindFirstChild("EZTargetPart") then
        targetPlayer.EZTargetPart:Destroy()
    end
    camLocked = false
    targetPlayer = nil
end

local function isInFOV(position)
    local screenPoint, onScreen = Camera:WorldToScreenPoint(position)
    if not onScreen then return false end
    local screenCenter = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    local screenPoint2D = Vector2.new(screenPoint.X, screenPoint.Y)
    local distanceFromCenter = (screenPoint2D - screenCenter).Magnitude
    return distanceFromCenter <= fovRadius
end

local function findClosestPlayer()
    local closestPlayer = nil
    local closestDistance = math.huge

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild(TargetPart) then
            local humanoidRootPart = player.Character[TargetPart]
            if isInFOV(humanoidRootPart.Position) then
                local distance = (humanoidRootPart.Position - LocalPlayer.Character[TargetPart].Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestPlayer = player.Character
                end
            end
        end
    end

    return closestPlayer
end

-- Toggle camera lock
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode[Keybind] then
        if camLocked then
            unlockCamera()
        else
            targetPlayer = findClosestPlayer()
            if targetPlayer then
                camLocked = true
                lockCamera(targetPlayer)
            end
        end
    end
end)

print("EZLOCK is now loaded")
